<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>No + Accidentes | Home</title>
  <link rel="icon" href="https://i.ibb.co/SBDtKpV/logo-No-Mas.png" type="image/x-icon">
    <!-- icheck bootstrap -->
  <link th:href="@{/plugins/icheck-bootstrap/icheck-bootstrap.min.css}" rel="stylesheet">
  <!-- Theme style -->
  <link th:href="@{/plugins/adminlte.min.css}" rel="stylesheet">
  <!-- Google Font: Source Sans Pro -->
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link th:href="@{/plugins/fontawesome-free/css/all.min.css}" rel="stylesheet">
  
  <link th:href="@{/plugins/datatablee/datatables.min.css}" rel="stylesheet">
  
  <link th:href="@{/plugins/switchery/switchery.css}" rel="stylesheet">
  
  
  <style>
  	.img-size-80 {
  		width: 80px;
  	}
  	td[colspan^="9"] {
		padding: 0px !important;
	}
	table.dataTable {
	    border-collapse: collapse  !important;
	}
	.pagination{
		display: grid;
		grid-auto-flow: column;
		grid-column-gap: 10px;
		margin-top:30px !important;
		text-align: center !important;
	}
	.dataTables_length > label > select {
		  display: flex !important; 
		  justify-content: flex-end !important;
		  border: 3px solid #73AD21 !important;
	}
  </style>
  
  
</head>
<body class="hold-transition sidebar-mini">
<!-- Site wrapper -->
<div class="wrapper">
  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <!-- Left navbar links -->
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars bg-secondary"></i></a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <a th:href="@{/home}" class="nav-link">Home</a>
      </li>
    </ul>

    <!-- Right navbar links -->
    <ul class="navbar-nav ml-auto">
      <!-- Navbar Search -->
      <li class="nav-item">
        <a class="nav-link" data-widget="navbar-search" href="#" role="button">
          <i class="fas fa-search"></i>
        </a>
        <div class="navbar-search-block">
          <form class="form-inline">
            <div class="input-group input-group-sm">
              <input class="form-control form-control-navbar" type="search" placeholder="Search" aria-label="Search">
              <div class="input-group-append">
                <button class="btn btn-navbar" type="submit">
                  <i class="fas fa-search"></i>
                </button>
                <button class="btn btn-navbar" type="button" data-widget="navbar-search">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
          </form>
        </div>
      </li>

      <!-- Messages Dropdown Menu -->
      <li class="nav-item dropdown">
        <a class="nav-link" data-toggle="dropdown" href="#">
          <i class="far fa-comments"></i>
          <span class="badge badge-danger navbar-badge">3</span>
        </a>
        <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
          <a href="#" class="dropdown-item">
            <!-- Message Start -->
            <div class="media">
              <img src="../../dist/img/user1-128x128.jpg" alt="User Avatar" class="img-size-50 mr-3 img-circle">
              <div class="media-body">
                <h3 class="dropdown-item-title">
                  Brad Diesel
                  <span class="float-right text-sm text-danger"><i class="fas fa-star"></i></span>
                </h3>
                <p class="text-sm">Call me whenever you can...</p>
                <p class="text-sm text-muted"><i class="far fa-clock mr-1"></i> 4 Hours Ago</p>
              </div>
            </div>
            <!-- Message End -->
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item">
            <!-- Message Start -->
            <div class="media">
              <img src="../../dist/img/user8-128x128.jpg" alt="User Avatar" class="img-size-50 img-circle mr-3">
              <div class="media-body">
                <h3 class="dropdown-item-title">
                  John Pierce
                  <span class="float-right text-sm text-muted"><i class="fas fa-star"></i></span>
                </h3>
                <p class="text-sm">I got your message bro</p>
                <p class="text-sm text-muted"><i class="far fa-clock mr-1"></i> 4 Hours Ago</p>
              </div>
            </div>
            <!-- Message End -->
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item">
            <!-- Message Start -->
            <div class="media">
              <img src="../../dist/img/user3-128x128.jpg" alt="User Avatar" class="img-size-50 img-circle mr-3">
              <div class="media-body">
                <h3 class="dropdown-item-title">
                  Nora Silvester
                  <span class="float-right text-sm text-warning"><i class="fas fa-star"></i></span>
                </h3>
                <p class="text-sm">The subject goes here</p>
                <p class="text-sm text-muted"><i class="far fa-clock mr-1"></i> 4 Hours Ago</p>
              </div>
            </div>
            <!-- Message End -->
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item dropdown-footer">See All Messages</a>
        </div>
      </li>
      <!-- Notifications Dropdown Menu -->
      <li class="nav-item dropdown">
        <a class="nav-link" data-toggle="dropdown" href="#">
          <i class="far fa-bell"></i>
          <span class="badge badge-warning navbar-badge">15</span>
        </a>
        <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
          <span class="dropdown-item dropdown-header">15 Notifications</span>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item">
            <i class="fas fa-envelope mr-2"></i> 4 new messages
            <span class="float-right text-muted text-sm">3 mins</span>
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item">
            <i class="fas fa-users mr-2"></i> 8 friend requests
            <span class="float-right text-muted text-sm">12 hours</span>
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item">
            <i class="fas fa-file mr-2"></i> 3 new reports
            <span class="float-right text-muted text-sm">2 days</span>
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item dropdown-footer">See All Notifications</a>
        </div>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-widget="fullscreen" href="#" role="button">
          <i class="fas fa-expand-arrows-alt"></i>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-widget="control-sidebar" data-slide="true" href="#" role="button">
          <i class="fas fa-th-large"></i>
        </a>
      </li>
    </ul>
  </nav>
  <!-- /.navbar -->

  <div th:include="include/sidebar"></div>

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
	<div th:include="include/content-header-mant"></div>
	
	

   <!-- SearchContent content -->
	<section class="content">

      <!-- Default box -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Busqueda de Contratos</h3>

          <div class="card-tools">
            <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
              <i class="fas fa-minus"></i>
            </button>
          </div>
        </div>
        <div class="card-body">
        	<div class="row">
        		<div class="col-4">
        			<div class="input-group mb-3">
			          <input type="text" class="form-control" placeholder="Fecha de Contrato" name="txtContrato" id="txtContrato" autocomplete="off">
			          <div class="input-group-append">
			            <div class="input-group-text">
			              <span class="fas fa-comment-alt"></span>
			            </div>
			          </div>
			        </div>
        		</div>

        		<div class="col-4">
        			<button type="button" class="btn btn-success" id="btnTest">
       					Buscar Contrato
	            		<i class="fas fa-search mr-2 mt-1"></i>
		            </button>
        		</div>
        	</div>


        </div>
        
      <!-- /.card-footer-->
      </div>
      <!-- /.card -->

    </section>
    <!-- /.content -->
    
     <!-- Main content -->
    <section class="content">

      <!-- Default box -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Lista de Contratos</h3>
<!--           	<div class="text-right"> -->
<!--           	   <button type="button" class="btn btn-success" data-toggle="modal" data-target="#modal-default"> -->
<!-- 	            	Agregar -->
<!-- 	          </button> -->
<!--           	</div> -->

          <div class="card-tools">
             
            <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
              <i class="fas fa-minus"></i>
            </button>
          </div>
        </div>
        <div class="card-body">
			<table class="table" id="table_contrato" width="99%">
			  <thead>
			    <tr style="color: #FFFFFF;background-color: #16CA85;">
				      <th scope="col">#</th>
				      <th scope="col">Pagos</th>
				      <th scope="col">Valor</th>
				      <th scope="col">Iva</th>
				      <th scope="col">Fecha de Contratación</th>
				      <th scope="col">Fecha de Termino de contrato</th>
				      <th scope="col">Representante</th>
				      <th scope="col">Empresa</th>
				      <th scope="col">Tipo Plan</th>
				      <th scope="col">Estado Contrato</th>
				      <th scope="col">Renovacion</th>
					  <th scope="col"></th>
			    </tr>
			  </thead>
			  <tbody>
			  </tbody>
			</table>
        </div>
        <!-- /.card-body -->
        <div class="card-footer">
          Footer
        </div>
        <!-- /.card-footer-->
      </div>
      <!-- /.card -->

    </section>
    <!-- /.content -->
    
  </div>
  <!-- /.content-wrapper -->
  
  	<div class="modal fade" id="modal-default">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title">Agregar Contrato</h4>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body text-center">
            	<img src="https://www.asimetrica.org/wp-content/uploads/2019/03/no-imagen.jpg" 
            	class="img-size-80 mb-3 img-circle" id="preview-img">
            	<form id="form-add-servicio">
	                <div class="input-group mb-3">
			          <input type="text" class="form-control" placeholder="Link imagen" name="image" id="linkImg" autocomplete="off">
			          <div class="input-group-append">
			            <button type="button" class="input-group-text" id="btnChangeImg">
			              <i class="fas fa-file-image"></i>
			            </button>
			          </div>
			        </div>
			        
			        <div class="input-group mb-3">
			          <input type="text" class="form-control" placeholder="Rut" name="rutUser" id="rutUser" autocomplete="off">
			          <div class="input-group-append">
			            <button type="button" class="input-group-text">
			              <i class="fas fa-file-image"></i>
			            </button>
			          </div>
			        </div>
			        
					<div class="input-group mb-3">
			          <input type="text" class="form-control" placeholder="Nombre de Usuario" name="nombreUser" id="nombreUser" autocomplete="off">
			          <div class="input-group-append">
			            <button type="button" class="input-group-text">
			              <i class="fas fa-file-image"></i>
			            </button>
			          </div>
			        </div>
			        <div class="input-group mb-3">
			          <input type="text" class="form-control" placeholder="Apellido de Usuario" name="apellidoUser" id="apellidoUser" autocomplete="off">
			          <div class="input-group-append">
			            <button type="button" class="input-group-text">
			              <i class="fas fa-file-image"></i>
			            </button>
			          </div>
			        </div>

			        <div class="input-group mb-3">
			          <input type="text" class="form-control" placeholder="Email" name="email" id="email" autocomplete="off">
			          <div class="input-group-append">
			            <button type="button" class="input-group-text">
			              <i class="fas fa-file-image"></i>
			            </button>
			          </div>
			        </div>
				
	            	<div class="modal-footer justify-content-between">
		              	<button type="button" class="btn btn-default" data-dismiss="modal" id="btn-close-modal">Cerrar</button>
						<button type="submit" class="btn btn-success">Guardar</button>
		           </div>
            	</form>
            </div>

          </div>
          <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
      </div>
      <!-- /.modal -->

  <div th:include="include/footer-main"></div>

  <!-- Control Sidebar -->
  <aside class="control-sidebar control-sidebar-dark">
    <!-- Control sidebar content goes here -->
  </aside>
  <!-- /.control-sidebar -->
</div>
<!-- ./wrapper -->

<!-- jQuery -->
<script th:src="@{/plugins/jquery/jquery.min.js}"></script>
<script th:src="@{/plugins/jquery-validation/jquery.validate.min.js}"></script>
<!-- Bootstrap 4 -->
<script th:src="@{/plugins/bootstrap/js/bootstrap.bundle.min.js}"></script>
<!-- AdminLTE App -->
<script th:src="@{/plugins/adminlte.min.js}"></script>
<!-- AdminLTE for demo purposes -->
<script th:src="@{/plugins/demo.js}"></script>

<script th:src="@{/plugins/datatablee/datatables.min.js}"></script>

<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Switchery -->
<script th:src="@{/plugins/switchery/switchery.js}"></script>
<script th:inline="javascript">
	$(document).ready(() => {
		searchContratoParams();
	})
	
	$("#btnTest").click(()=>{
		searchContratoParams();
	})
	
	const searchContratoParams = () => {
		let fechaTermino = $('#txtContrato').val(); 
		searchContrato(fechaTermino.length === 0 ? 'false':fechaTermino );
	}

	let table;
	
	const searchContrato = (fechaTermino) => {
		$("#btnSearchContrato").prop( "disabled", true );
       	 var URL = `/ajax/listContrato/false/${fechaTermino}`;
           	if ( $.fn.DataTable.isDataTable('#table_contrato') ) {
       			table.ajax.url(URL).load();
				return;
      		}else{
      			table = $('#table_contrato').DataTable({
                    lengthChange: false,
                    serverSide: false,
                    searching:false,
                    responsive: true,
                    pageLength: 50,
                    ordering: false,
                    paging: false,
                    pagingType: "full_numbers",
                    processing: true,
                    autoWidth: true,
                    bDestroy: true,
		                "ajax": {
		                    url: URL,
		                    dataSrc: 'data'
		                },
		                "columns": [
		                	{ data: null,"defaultContent": '', className:"details-control"},
		                    { data: 'comentario'},
		                    { data: 'valor'},
		                    { data: 'valorExtra'},
		                    { data: 'fechaContratacion'},
		                    { data: 'fechaTermino'},
		                    { data: 'representante.nombreRepre'}, 
		                    { data: 'empresa.nombreEmpresa'},
		                    { data: 'tipoPlan.nombrePlan'},  
		                    { data: 'estadoContrato.descripcion'},
		                    { data: 'renovacion'},       
		               	    { data: null}
		                ],
		                columnDefs:[
		                	{
		                		"targets":[1],
		                		"render": function(data,type,row){
		                			return `			
		                			<div>				
		                				<span style="cursor: pointer;" id="${row.idContrato}_comentario" onclick="editValueByField(${row.idContrato},'comentario','Comentario')">${row.comentario}</span>
		                			</div>
		                			`    			
		                		}		
		                	},
		                	{
		                		"targets":[10],
		                		"render": function(data,type,row){
		                			let badge = data === 'Y' ? 'primary' : 'danger';
		                			data = data === 'Y' ? 'Contrato al día' : 'Contrato impago';
		                			return `<span class="badge badge-${badge}" id="${row.idContrato}_cont">${data}</span>`    			
		                		}		
		                	},
		                	{
		                		"targets":[11],
		                		"render": function(data,type,row){
		                			if(row.renovacion === 'N'){
		                				return `<button  id="${row.idContrato}_btn" type="button" class="btn btn-success btn-sm" onclick="btnPagar(${row.idContrato},${row.valor})">Pagar</button>`;
		                			}
		                			
		                			return '';		
		                		}		
		                	},
		                ],
					drawCallback:( settings ) => {
	                	$("#btnSearchContrato").prop( "disabled", false );
	  		        },
      			});
      		}
        }
        
      $('#table_contrato').on('draw.dt', () => {
		  $('.js-switch').each(( index, element ) => {
              	switchery = new Switchery(element, { color: '#1AB394', secondaryColor: '#ED5565', size: 'small' });
      	   });
	  });
	  
	 const updateStatus = (idUser) => {
 	 	updateUser(idUser,'active',$(`#${idUser}_check`)[0].checked ? 'Y':'N',true);
 	 }
 	 
 	 const number_format = (amount, decimals) => {

	    amount += ''; 
	    amount = parseFloat(amount.replace(/[^0-9\.]/g, ''));

	    decimals = decimals || 0;

	    if (isNaN(amount) || amount === 0) return parseFloat(0).toFixed(decimals);

	    amount = '' + amount.toFixed(decimals);

	    var amount_parts = amount.split('.'),
	        regexp = /(\d+)(\d{3})/;

	    while (regexp.test(amount_parts[0]))
	        amount_parts[0] = amount_parts[0].replace(regexp, '$1' + '.' + '$2');

	    return `$${amount_parts.join('.')}`;
	}
	  
	  const editValueByField = ( id,field,title ) => {
	    	 
	    	 const oldValue = $(`#${id}_${field}`).text();
	    	 const input = `
	    	 	<div class="input-group mb-3">
		          <input type="text" class="form-control" placeholder="${title}" name="valueEdit" id="valueEdit" autocomplete="off" value="${oldValue}">
		          <div class="input-group-append" onclick="changeImage();">
		            <div class="input-group-text">
		              <span class="fas fa-comment-alt"></span>
		            </div>
		          </div>
		        </div>`;
	  		let options = '';
	  	    Swal.fire({
	  	    title: `<strong>Modificar ${title}</strong>`,
	  	    icon: 'info',
 	  	    html:input,
	  	    showCloseButton: true,
	  	    showCancelButton: true,
	  	    focusConfirm: false,
	  	    confirmButtonText:'Modificar',
	  	    confirmButtonAriaLabel: 'Cancelar',
	  	    cancelButtonText:'Cancelar',
	  	    cancelButtonAriaLabel: 'Thumbs down',
	  	  })
	  	  .then((result) => {
	  		  if (result.isConfirmed) {
	  			  const value = $('#valueEdit').val();
	  			  
	  			  if(value === oldValue || value === $(`#${id}_${field}`).attr("src")){
		        	 	Swal.fire({
							  position: 'top-end',
							  icon: 'error',
							  title: 'No se ha actualizado nada',
							  showConfirmButton: false,
							  timer: 1500
							})
						return;
	  			  }
	  			updateContrato(id,field,value);
	  			return;
	  		  }
	  		})
	      }
	      
	  const updateContrato = (idContrato,field,value,status) => {
	        $.ajax({
	        	  url: `/ajax/updateContrato/${idContrato}/${field}/${value}`,
	            type: "PUT",
	            data: null,
	            dataType: "json",
	            async: false,
	            contentType: "application/json; charset=utf-8",
	            success: (data) => {
		            if(!status){
		            	$(`#${idContrato}_${field}`).text(value);
		            }
	            }
	    	});
		}
		
		const btnPagar = (idContrato,monto) => {

	  	   Swal.fire({
	  	    title: `<strong>¿Desea pagar $${monto} con la tarjeta asociada?</strong>`,
	  	    icon: 'info',
 	  	    html:null,
	  	    showCloseButton: true,
	  	    showCancelButton: true,
	  	    focusConfirm: false,
	  	    confirmButtonText:'Pagar',
	  	    confirmButtonAriaLabel: 'Cancelar',
	  	    cancelButtonText:'Cancelar',
	  	    cancelButtonAriaLabel: 'Thumbs down',
	  	  })
	  	  .then((result) => {
	  		  if (result.isConfirmed) {
	  			generatePago(idContrato,monto);

	  			return;
	  		  }
	  		})
		}
		
		const generatePago = (idContrato,monto) => {
	        $.ajax({
	        	  url: `/ajax/generatePago/${idContrato}/${monto}`,
	            type: "POST",
	            data: null,
	            dataType: "json",
	            async: false,
	            contentType: "application/json; charset=utf-8",
	            success: (data) => {
		            if(data){
		            	$(`#${idContrato}_cont`).text(`Contrato al día`);
			  			$(`#${idContrato}_cont`).attr('class', 'badge badge-primary');
			  			$(`#${idContrato}_btn`).attr('class', 'd-none');
		            }
	            }
	    	});
		}
</script>